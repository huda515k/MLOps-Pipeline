name: CD - Test to Master

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Fetch model from MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          python -m pip install --upgrade pip
          pip install mlflow dagshub
          python -c "
          import mlflow
          import os
          import shutil
          from pathlib import Path
          
          mlflow.set_tracking_uri(os.getenv('MLFLOW_TRACKING_URI'))
          client = mlflow.tracking.MlflowClient()
          experiment = client.get_experiment_by_name('weather_forecasting')
          
          if experiment:
              runs = client.search_runs(experiment.experiment_id, order_by=['metrics.val_rmse ASC'], max_results=1)
              if runs:
                  run_id = runs[0].info.run_id
                  model_uri = f'runs:/{run_id}/model'
                  
                  # Download model
                  Path('models').mkdir(exist_ok=True)
                  mlflow.sklearn.save_model(mlflow.sklearn.load_model(model_uri), 'models/weather_model')
                  print(f'Model downloaded from run: {run_id}')
          "
      
      - name: Build Docker image
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          docker build -f docker/Dockerfile.fastapi -t ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:$VERSION .
          docker tag ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:$VERSION ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:latest
      
      - name: Push Docker image
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          docker push ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:$VERSION
          docker push ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:latest
      
      - name: Verify deployment
        run: |
          echo "Docker image built and pushed successfully"
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:latest"
          echo ""
          echo "To deploy, run:"
          echo "docker run -d -p 8000:8000 ${{ secrets.DOCKER_USERNAME }}/weather-forecast-api:latest"

